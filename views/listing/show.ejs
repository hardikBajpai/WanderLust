<% layout("/layouts/boilerplate") %>

<div class="container my-4">
  <h3 class="fw-bold text-center mb-3"><%= listing.title %></h3>

  <div class="card mx-auto shadow-sm" 
       style="width: 40rem; border-radius: 15px;">

    <img 
      src="<%= listing.image.url %>" 
      class="card-img-top" 
      alt="Listing Image" 
      style="border-top-left-radius: 15px; 
             border-top-right-radius: 15px; 
             height: 300px; 
             object-fit: cover;">

    <div class="card-body">
       <i> Owned by : <%= listing.owner.username %></i>
      <p class="card-text"><%= listing.description %></p>
      <p class="card-text mb-1">₹ <%= listing.price.toLocaleString("en-IN") %></p>
      <p class="card-text mb-1"><%= listing.location %></p>
      <p class="card-text text-muted"><%= listing.country %></p>

      <!-- Buttons Row -->
       <% if(currUser && currUser._id.toString()===listing.owner._id.toString()){ %>
      <div class="d-flex gap-2 mt-3">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-danger">Edit</a>

        <form 
          action="/listings/<%= listing._id %>?_method=DELETE"
          method="POST">
          <button type="submit" class="btn btn-dark">Delete</button>
        </form>
      </div>
    <%}%>
      <hr>

      <!-- Review Form -->
      <div class="mt-3">
        <% if(currUser) {%>
        <h4 class="mb-3">Leave a Review</h4>

        <form action="/listings/<%= listing._id %>/reviews" 
              method="POST" 
              class="needs-validation" novalidate>

          <div class="mb-3">
            <label for="rating" class="form-label">Rating</label>
            <input 
              type="range" 
              min="1" 
              max="5" 
              id="rating" 
              name="review[rating]" 
              class="form-range">
          </div>

          <div class="mb-3">
            <label for="comments" class="form-label">Comments</label>
            <textarea 
              name="review[comment]" 
              id="comments" 
              rows="4" 
              class="form-control" 
              required></textarea>
            <div class="invalid-feedback">
              Please add some comments for review.
            </div>
          </div>

          <button class="btn btn-outline-dark">Submit</button>
        </form>
<% } %>
        <hr>

        <!-- Reviews Section -->
<hr>

<p class="fw-bold mb-3">All Reviews</p>

<div class="row g-3">
  <% for (let i = 0; i < listing.reviews.length; i++) { %>

    <div class="col-6">
      <div class="border rounded p-3 shadow-sm bg-light h-100">
        <h6 class="fw-bold"><%= listing.reviews[i].author.username%></h6>
        <p class="mb-1"><%= listing.reviews[i].comment %></p>
        <p class="text-muted mb-0">Rating: <%= listing.reviews[i].rating %> ⭐</p>
        <form class="mt-3" method="POST" action="/listings/<%= listing._id %>/reviews/<%= listing.reviews[i]._id %>?_method=DELETE">

          <button class="btn btn-dark">Delete</button>
        </form>
      </div>
    </div>

  <% } %>
</div>


      </div>

    </div>
  </div>
</div>
